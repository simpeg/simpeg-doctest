
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "content/examples/10-pgi/plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_content_examples_10-pgi_plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_content_examples_10-pgi_plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py:


Petrophysically guided inversion: Joint linear example with nonlinear relationships
===================================================================================

We do a comparison between the classic least-squares inversion
and our formulation of a petrophysically guided inversion.
We explore it through coupling two linear problems whose respective physical
properties are linked by polynomial relationships that change between rock units.

.. GENERATED FROM PYTHON SOURCE LINES 11-432



.. image-sg:: /content/examples/10-pgi/images/sphx_glr_plot_inv_1_PGI_Linear_1D_joint_WithRelationships_001.png
   :alt: Problem 1, Problem 2, Petrophysical Distribution, Problem 1, Problem 2, Petrophysical Distribution, Problem 1, Problem 2, Petro Distribution
   :srcset: /content/examples/10-pgi/images/sphx_glr_plot_inv_1_PGI_Linear_1D_joint_WithRelationships_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    SimPEG.InvProblem will set Regularization.reference_model to m0.
    SimPEG.InvProblem will set Regularization.reference_model to m0.
    SimPEG.InvProblem will set Regularization.reference_model to m0.

                        SimPEG.InvProblem is setting bfgsH0 to the inverse of the eval2Deriv.
                        ***Done using the default solver Pardiso and no solver_opts.***
                    
    Alpha scales: [3.466585984471505, 0.0, 3.497667477042771e-06, 0.0]
    Calculating the scaling parameter.
    Scale Multipliers:  [0.10072153 0.89927847]
    <class 'SimPEG.regularization.pgi.PGIsmallness'>
    Initial data misfit scales:  [0.10072153 0.89927847]
    model has any nan: 0
    =============================== Projected GNCG ===============================
      #     beta     phi_d     phi_m       f      |proj(x-g)-x|  LS    Comment   
    -----------------------------------------------------------------------------
    x0 has any nan: 0
       0  1.94e+01  3.00e+05  0.00e+00  3.00e+05    1.41e+02      0              
    geophys. misfits: 966.3 (target 30.0 [False]); 89.0 (target 30.0 [False]) | smallness misfit: 3002.6 (target: 200.0 [False])
    Beta cooling evaluation: progress: [966.3  89. ]; minimum progress targets: [240000. 240000.]
       1  1.94e+01  1.77e+02  4.14e+01  9.79e+02    9.77e+01      0              
    geophys. misfits: 435.6 (target 30.0 [False]); 31.8 (target 30.0 [False]) | smallness misfit: 1426.0 (target: 200.0 [False])
    Beta cooling evaluation: progress: [435.6  31.8]; minimum progress targets: [773.   71.2]
       2  1.94e+01  7.25e+01  4.02e+01  8.51e+02    6.06e+01      0   Skip BFGS  
    geophys. misfits: 428.0 (target 30.0 [False]); 31.5 (target 30.0 [False]) | smallness misfit: 1415.1 (target: 200.0 [False])
    Beta cooling evaluation: progress: [428.   31.5]; minimum progress targets: [348.5  30. ]
    Decreasing beta to counter data misfit decrase plateau.
       3  9.69e+00  7.15e+01  4.02e+01  4.61e+02    8.54e+01      0   Skip BFGS  
    geophys. misfits: 155.7 (target 30.0 [False]); 24.8 (target 30.0 [True]) | smallness misfit: 1505.1 (target: 200.0 [False])
    Beta cooling evaluation: progress: [155.7  24.8]; minimum progress targets: [342.4  30. ]
    Updating scaling for data misfits by  1.2082532792322445
    New scales: [0.11919689 0.88080311]
       4  9.69e+00  4.04e+01  4.26e+01  4.53e+02    7.83e+01      0              
    geophys. misfits: 133.4 (target 30.0 [False]); 25.3 (target 30.0 [True]) | smallness misfit: 1448.8 (target: 200.0 [False])
    Beta cooling evaluation: progress: [133.4  25.3]; minimum progress targets: [124.6  30. ]
    Decreasing beta to counter data misfit decrase plateau.
    Updating scaling for data misfits by  1.184501830606156
    New scales: [0.13815072 0.86184928]
       5  4.85e+00  4.03e+01  4.28e+01  2.47e+02    7.77e+01      0   Skip BFGS  
    geophys. misfits: 56.6 (target 30.0 [False]); 21.5 (target 30.0 [True]) | smallness misfit: 1645.0 (target: 200.0 [False])
    Beta cooling evaluation: progress: [56.6 21.5]; minimum progress targets: [106.8  30. ]
    Updating scaling for data misfits by  1.3955677993157896
    New scales: [0.18280858 0.81719142]
       6  4.85e+00  2.79e+01  4.46e+01  2.44e+02    6.75e+01      0              
    geophys. misfits: 39.8 (target 30.0 [False]); 21.8 (target 30.0 [True]) | smallness misfit: 1550.4 (target: 200.0 [False])
    Beta cooling evaluation: progress: [39.8 21.8]; minimum progress targets: [45.3 30. ]
    Updating scaling for data misfits by  1.3734638110942976
    New scales: [0.2350346 0.7649654]
       7  4.85e+00  2.61e+01  4.48e+01  2.43e+02    7.73e+01      0              
    geophys. misfits: 30.7 (target 30.0 [False]); 21.6 (target 30.0 [True]) | smallness misfit: 1529.9 (target: 200.0 [False])
    Beta cooling evaluation: progress: [30.7 21.6]; minimum progress targets: [31.8 30. ]
    Updating scaling for data misfits by  1.3869579953662992
    New scales: [0.29880705 0.70119295]
       8  4.85e+00  2.43e+01  4.51e+01  2.43e+02    6.43e+01      0              
    geophys. misfits: 26.4 (target 30.0 [True]); 22.1 (target 30.0 [True]) | smallness misfit: 1482.0 (target: 200.0 [False])
    Beta cooling evaluation: progress: [26.4 22.1]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  1.2484672346702117
       9  4.85e+00  2.34e+01  4.60e+01  2.46e+02    5.63e+01      0              
    geophys. misfits: 25.5 (target 30.0 [True]); 22.6 (target 30.0 [True]) | smallness misfit: 1408.8 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.5 22.6]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  1.5637409476005435
      10  4.85e+00  2.34e+01  4.69e+01  2.51e+02    5.43e+01      0              
    geophys. misfits: 24.7 (target 30.0 [True]); 23.5 (target 30.0 [True]) | smallness misfit: 1301.0 (target: 200.0 [False])
    Beta cooling evaluation: progress: [24.7 23.5]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  1.9475709832572525
      11  4.85e+00  2.39e+01  4.78e+01  2.56e+02    5.54e+01      0              
    geophys. misfits: 23.9 (target 30.0 [True]); 24.6 (target 30.0 [True]) | smallness misfit: 1197.7 (target: 200.0 [False])
    Beta cooling evaluation: progress: [23.9 24.6]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  2.4092276377355497
      12  4.85e+00  2.44e+01  4.89e+01  2.61e+02    6.86e+01      0              
    geophys. misfits: 24.0 (target 30.0 [True]); 25.6 (target 30.0 [True]) | smallness misfit: 1101.4 (target: 200.0 [False])
    Beta cooling evaluation: progress: [24.  25.6]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  2.9181020357016614
      13  4.85e+00  2.51e+01  4.98e+01  2.67e+02    6.88e+01      0              
    geophys. misfits: 23.6 (target 30.0 [True]); 26.6 (target 30.0 [True]) | smallness misfit: 1013.4 (target: 200.0 [False])
    Beta cooling evaluation: progress: [23.6 26.6]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  3.4942238289586496
      14  4.85e+00  2.57e+01  5.09e+01  2.72e+02    8.61e+01      0              
    geophys. misfits: 23.6 (target 30.0 [True]); 27.6 (target 30.0 [True]) | smallness misfit: 935.0 (target: 200.0 [False])
    Beta cooling evaluation: progress: [23.6 27.6]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  4.116565686998863
      15  4.85e+00  2.64e+01  5.19e+01  2.78e+02    5.10e+01      0              
    geophys. misfits: 24.8 (target 30.0 [True]); 29.1 (target 30.0 [True]) | smallness misfit: 862.0 (target: 200.0 [False])
    Beta cooling evaluation: progress: [24.8 29.1]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  4.607685670555163
      16  4.85e+00  2.78e+01  5.25e+01  2.82e+02    6.26e+01      0              
    geophys. misfits: 25.0 (target 30.0 [True]); 29.8 (target 30.0 [True]) | smallness misfit: 815.8 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.  29.8]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  5.0860237379674835
      17  4.85e+00  2.83e+01  5.32e+01  2.86e+02    5.01e+01      0   Skip BFGS  
    geophys. misfits: 25.1 (target 30.0 [True]); 30.4 (target 30.0 [False]) | smallness misfit: 776.9 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.1 30.4]; minimum progress targets: [30. 30.]
    Decreasing beta to counter data misfit increase.
    Updating scaling for data misfits by  1.1932292051797553
    New scales: [0.2631523 0.7368477]
      18  2.42e+00  2.90e+01  5.30e+01  1.58e+02    9.38e+01      0   Skip BFGS  
    geophys. misfits: 21.4 (target 30.0 [True]); 25.4 (target 30.0 [True]) | smallness misfit: 893.7 (target: 200.0 [False])
    Beta cooling evaluation: progress: [21.4 25.4]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  6.570807892697828
      19  2.42e+00  2.44e+01  5.72e+01  1.63e+02    8.27e+01      0              
    geophys. misfits: 21.1 (target 30.0 [True]); 25.0 (target 30.0 [True]) | smallness misfit: 793.9 (target: 200.0 [False])
    Beta cooling evaluation: progress: [21.1 25. ]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  8.629801278763168
      20  2.42e+00  2.39e+01  6.05e+01  1.71e+02    8.54e+01      0              
    geophys. misfits: 20.9 (target 30.0 [True]); 24.5 (target 30.0 [True]) | smallness misfit: 743.5 (target: 200.0 [False])
    Beta cooling evaluation: progress: [20.9 24.5]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  11.46127310455188
      21  2.42e+00  2.36e+01  6.49e+01  1.81e+02    9.67e+01      0              
    geophys. misfits: 21.5 (target 30.0 [True]); 24.3 (target 30.0 [True]) | smallness misfit: 625.0 (target: 200.0 [False])
    Beta cooling evaluation: progress: [21.5 24.3]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  15.063107314178314
      22  2.42e+00  2.36e+01  6.91e+01  1.91e+02    9.57e+01      0              
    geophys. misfits: 22.5 (target 30.0 [True]); 24.9 (target 30.0 [True]) | smallness misfit: 569.4 (target: 200.0 [False])
    Beta cooling evaluation: progress: [22.5 24.9]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  19.116820961397895
      23  2.42e+00  2.43e+01  7.31e+01  2.01e+02    1.03e+02      0              
    geophys. misfits: 25.8 (target 30.0 [True]); 28.0 (target 30.0 [True]) | smallness misfit: 427.8 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.8 28. ]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  21.351496960634027
      24  2.42e+00  2.74e+01  7.26e+01  2.03e+02    9.84e+01      0              
    geophys. misfits: 26.1 (target 30.0 [True]); 28.1 (target 30.0 [True]) | smallness misfit: 409.0 (target: 200.0 [False])
    Beta cooling evaluation: progress: [26.1 28.1]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  23.649848700822456
      25  2.42e+00  2.76e+01  7.43e+01  2.08e+02    9.91e+01      0              
    geophys. misfits: 28.0 (target 30.0 [True]); 29.7 (target 30.0 [True]) | smallness misfit: 381.9 (target: 200.0 [False])
    Beta cooling evaluation: progress: [28.  29.7]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  24.621145477140445
      26  2.42e+00  2.92e+01  7.40e+01  2.09e+02    9.54e+01      0              
    geophys. misfits: 29.4 (target 30.0 [True]); 30.1 (target 30.0 [False]) | smallness misfit: 368.2 (target: 200.0 [False])
    Beta cooling evaluation: progress: [29.4 30.1]; minimum progress targets: [30. 30.]
    Decreasing beta to counter data misfit increase.
    Updating scaling for data misfits by  1.022057642919253
    New scales: [0.25894366 0.74105634]
      27  1.21e+00  2.99e+01  7.35e+01  1.19e+02    9.86e+01      0              
    geophys. misfits: 25.7 (target 30.0 [True]); 27.4 (target 30.0 [True]) | smallness misfit: 369.8 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.7 27.4]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  27.839091422344193
      28  1.21e+00  2.70e+01  7.79e+01  1.21e+02    6.71e+01      0              
    geophys. misfits: 25.0 (target 30.0 [True]); 27.1 (target 30.0 [True]) | smallness misfit: 363.7 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.  27.1]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  32.0973939868248
      29  1.21e+00  2.66e+01  8.14e+01  1.25e+02    7.69e+01      0              
    geophys. misfits: 25.5 (target 30.0 [True]); 26.5 (target 30.0 [True]) | smallness misfit: 349.2 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.5 26.5]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  37.042556933505864
      30  1.21e+00  2.63e+01  8.50e+01  1.29e+02    9.01e+01      0              
    geophys. misfits: 25.6 (target 30.0 [True]); 26.1 (target 30.0 [True]) | smallness misfit: 333.7 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.6 26.1]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  42.94071341834744
      31  1.21e+00  2.60e+01  8.92e+01  1.34e+02    9.33e+01      0              
    geophys. misfits: 25.4 (target 30.0 [True]); 25.7 (target 30.0 [True]) | smallness misfit: 318.0 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.4 25.7]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  50.47253961092427
      32  1.21e+00  2.56e+01  9.44e+01  1.40e+02    1.01e+02      0              
    geophys. misfits: 26.2 (target 30.0 [True]); 24.9 (target 30.0 [True]) | smallness misfit: 300.6 (target: 200.0 [False])
    Beta cooling evaluation: progress: [26.2 24.9]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  59.27545942450516
      33  1.21e+00  2.52e+01  9.99e+01  1.46e+02    1.04e+02      0              
    geophys. misfits: 26.2 (target 30.0 [True]); 24.6 (target 30.0 [True]) | smallness misfit: 287.4 (target: 200.0 [False])
    Beta cooling evaluation: progress: [26.2 24.6]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  70.17798710729143
      34  1.21e+00  2.50e+01  1.07e+02  1.54e+02    1.08e+02      0              
    geophys. misfits: 27.4 (target 30.0 [True]); 24.7 (target 30.0 [True]) | smallness misfit: 272.4 (target: 200.0 [False])
    Beta cooling evaluation: progress: [27.4 24.7]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  81.15517412520956
      35  1.21e+00  2.54e+01  1.12e+02  1.61e+02    1.09e+02      0              
    geophys. misfits: 27.8 (target 30.0 [True]); 24.7 (target 30.0 [True]) | smallness misfit: 262.7 (target: 200.0 [False])
    Beta cooling evaluation: progress: [27.8 24.7]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  93.12050937402647
      36  1.21e+00  2.55e+01  1.19e+02  1.69e+02    1.11e+02      0              
    geophys. misfits: 29.7 (target 30.0 [True]); 25.2 (target 30.0 [True]) | smallness misfit: 243.8 (target: 200.0 [False])
    Beta cooling evaluation: progress: [29.7 25.2]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  102.43337481045032
      37  1.21e+00  2.64e+01  1.22e+02  1.74e+02    1.08e+02      0              
    geophys. misfits: 30.9 (target 30.0 [False]); 25.2 (target 30.0 [True]) | smallness misfit: 236.5 (target: 200.0 [False])
    Beta cooling evaluation: progress: [30.9 25.2]; minimum progress targets: [30. 30.]
    Decreasing beta to counter data misfit increase.
    Updating scaling for data misfits by  1.1913500079502863
    New scales: [0.29392869 0.70607131]
      38  6.06e-01  2.69e+01  1.21e+02  1.00e+02    8.60e+01      0              
    geophys. misfits: 26.9 (target 30.0 [True]); 24.9 (target 30.0 [True]) | smallness misfit: 245.0 (target: 200.0 [False])
    Beta cooling evaluation: progress: [26.9 24.9]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  118.88629214970922
      39  6.06e-01  2.55e+01  1.32e+02  1.05e+02    9.50e+01      0              
    geophys. misfits: 25.7 (target 30.0 [True]); 23.9 (target 30.0 [True]) | smallness misfit: 236.9 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.7 23.9]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  144.05436239991766
      40  6.06e-01  2.44e+01  1.45e+02  1.12e+02    1.05e+02      0              
    geophys. misfits: 25.9 (target 30.0 [True]); 23.9 (target 30.0 [True]) | smallness misfit: 232.7 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.9 23.9]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  173.72604944569912
      41  6.06e-01  2.45e+01  1.59e+02  1.21e+02    1.06e+02      0              
    geophys. misfits: 25.2 (target 30.0 [True]); 23.7 (target 30.0 [True]) | smallness misfit: 223.8 (target: 200.0 [False])
    Beta cooling evaluation: progress: [25.2 23.7]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  213.56729620221031
      42  6.06e-01  2.41e+01  1.78e+02  1.32e+02    1.13e+02      0              
    geophys. misfits: 23.7 (target 30.0 [True]); 24.5 (target 30.0 [True]) | smallness misfit: 210.0 (target: 200.0 [False])
    Beta cooling evaluation: progress: [23.7 24.5]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  266.124555070999
      43  6.06e-01  2.42e+01  1.99e+02  1.45e+02    1.18e+02      0              
    geophys. misfits: 24.7 (target 30.0 [True]); 23.9 (target 30.0 [True]) | smallness misfit: 207.9 (target: 200.0 [False])
    Beta cooling evaluation: progress: [24.7 23.9]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  328.8735987870662
      44  6.06e-01  2.41e+01  2.25e+02  1.60e+02    1.21e+02      1              
    geophys. misfits: 25.0 (target 30.0 [True]); 25.4 (target 30.0 [True]) | smallness misfit: 192.2 (target: 200.0 [True])
    All targets have been reached
    Beta cooling evaluation: progress: [25.  25.4]; minimum progress targets: [30. 30.]
    Warming alpha_pgi to favor clustering:  391.7835598781837
    ------------------------- STOP! -------------------------
    1 : |fc-fOld| = 0.0000e+00 <= tolF*(1+|f0|) = 3.0000e+04
    0 : |xc-x_last| = 7.2951e-01 <= tolX*(1+|x0|) = 1.0000e-06
    0 : |proj(x-g)-x|    = 1.2082e+02 <= tolG          = 1.0000e-01
    0 : |proj(x-g)-x|    = 1.2082e+02 <= 1e3*eps       = 1.0000e-02
    0 : maxIter   =      50    <= iter          =     45
    ------------------------- DONE! -------------------------
    SimPEG.InvProblem will set Regularization.reference_model to m0.
    SimPEG.InvProblem will set Regularization.reference_model to m0.
    SimPEG.InvProblem will set Regularization.reference_model to m0.

                        SimPEG.InvProblem is setting bfgsH0 to the inverse of the eval2Deriv.
                        ***Done using the default solver Pardiso and no solver_opts.***
                    
    Alpha scales: [0.00034499025026179766, 0.0, 3.7949084087632494e-06, 0.0]
    Calculating the scaling parameter.
    Scale Multipliers:  [0.10072153 0.89927847]
    <class 'SimPEG.regularization.pgi.PGIsmallness'>
    Initial data misfit scales:  [0.10072153 0.89927847]
    model has any nan: 0
    =============================== Projected GNCG ===============================
      #     beta     phi_d     phi_m       f      |proj(x-g)-x|  LS    Comment   
    -----------------------------------------------------------------------------
    x0 has any nan: 0
       0  1.93e+03  3.00e+05  0.00e+00  3.00e+05    1.41e+02      0              
    geophys. misfits: 85443.8 (target 30.0 [False]); 62629.0 (target 30.0 [False]) | smallness misfit: 286.5 (target: 200.0 [False])
    Beta cooling evaluation: progress: [85443.8 62629. ]; minimum progress targets: [240000. 240000.]
       1  1.93e+03  6.49e+04  6.80e-01  6.62e+04    9.16e+01      0              
    geophys. misfits: 586.3 (target 30.0 [False]); 24.7 (target 30.0 [True]) | smallness misfit: 88.8 (target: 200.0 [True])
    Beta cooling evaluation: progress: [586.3  24.7]; minimum progress targets: [68355.  50103.2]
    Updating scaling for data misfits by  1.2153324740498122
    New scales: [0.1198116 0.8801884]
       2  1.93e+03  9.20e+01  2.40e-01  5.56e+02    9.29e+01      0   Skip BFGS  
    geophys. misfits: 103.0 (target 30.0 [False]); 22.7 (target 30.0 [True]) | smallness misfit: 55.8 (target: 200.0 [True])
    Beta cooling evaluation: progress: [103.   22.7]; minimum progress targets: [469.1  30. ]
    Updating scaling for data misfits by  1.3214718774520724
    New scales: [0.15245567 0.84754433]
       3  1.93e+03  3.49e+01  1.47e-01  3.18e+02    7.92e+01      0   Skip BFGS  
    geophys. misfits: 70.3 (target 30.0 [False]); 22.1 (target 30.0 [True]) | smallness misfit: 46.7 (target: 200.0 [True])
    Beta cooling evaluation: progress: [70.3 22.1]; minimum progress targets: [82.4 30. ]
    Updating scaling for data misfits by  1.3556314216024976
    New scales: [0.19604454 0.80395546]
       4  1.93e+03  3.16e+01  1.27e-01  2.78e+02    7.72e+01      0              
    geophys. misfits: 53.0 (target 30.0 [False]); 22.5 (target 30.0 [True]) | smallness misfit: 47.4 (target: 200.0 [True])
    Beta cooling evaluation: progress: [53.  22.5]; minimum progress targets: [56.2 30. ]
    Updating scaling for data misfits by  1.3325464243098517
    New scales: [0.24524967 0.75475033]
       5  1.93e+03  3.00e+01  1.29e-01  2.79e+02    6.35e+01      0   Skip BFGS  
    geophys. misfits: 42.4 (target 30.0 [False]); 23.0 (target 30.0 [True]) | smallness misfit: 47.9 (target: 200.0 [True])
    Beta cooling evaluation: progress: [42.4 23. ]; minimum progress targets: [42.4 30. ]
    Decreasing beta to counter data misfit decrase plateau.
    Updating scaling for data misfits by  1.3068506899739274
    New scales: [0.29807319 0.70192681]
       6  9.66e+02  2.88e+01  1.30e-01  1.54e+02    9.52e+01      0   Skip BFGS  
    geophys. misfits: 25.4 (target 30.0 [True]); 20.8 (target 30.0 [True]) | smallness misfit: 49.9 (target: 200.0 [True])
    All targets have been reached
    Beta cooling evaluation: progress: [25.4 20.8]; minimum progress targets: [33.9 30. ]
    Warming alpha_pgi to favor clustering:  1.310692133322119
    ------------------------- STOP! -------------------------
    1 : |fc-fOld| = 0.0000e+00 <= tolF*(1+|f0|) = 3.0000e+04
    0 : |xc-x_last| = 1.2100e-01 <= tolX*(1+|x0|) = 1.0000e-06
    0 : |proj(x-g)-x|    = 9.5145e+01 <= tolG          = 1.0000e-01
    0 : |proj(x-g)-x|    = 9.5145e+01 <= 1e3*eps       = 1.0000e-02
    0 : maxIter   =      50    <= iter          =      7
    ------------------------- DONE! -------------------------
    SimPEG.InvProblem will set Regularization.reference_model to m0.
    SimPEG.InvProblem will set Regularization.reference_model to m0.

                        SimPEG.InvProblem is setting bfgsH0 to the inverse of the eval2Deriv.
                        ***Done using the default solver Pardiso and no solver_opts.***
                    
    Alpha scales: [3.5188574849327586e-05, 0.0, 3.4826374354602616e-05, 0.0]
    Calculating the scaling parameter.
    Scale Multipliers:  [0.10072153 0.89927847]
    /home/ssoler/git/simpeg/SimPEG/directives/directives.py:332: UserWarning:

    There is no PGI regularization. Smallness target is turned off (TriggerSmall flag)

    Initial data misfit scales:  [0.10072153 0.89927847]
    model has any nan: 0
    =============================== Projected GNCG ===============================
      #     beta     phi_d     phi_m       f      |proj(x-g)-x|  LS    Comment   
    -----------------------------------------------------------------------------
    x0 has any nan: 0
       0  1.05e+06  3.00e+05  0.00e+00  3.00e+05    1.41e+02      0              
    geophys. misfits: 54371.1 (target 30.0 [False]); 36104.4 (target 30.0 [False])
       1  2.09e+05  3.79e+04  4.24e-02  4.68e+04    1.38e+02      0              
    geophys. misfits: 7836.5 (target 30.0 [False]); 3929.5 (target 30.0 [False])
       2  4.19e+04  4.32e+03  1.06e-01  8.77e+03    1.32e+02      0   Skip BFGS  
    geophys. misfits: 512.7 (target 30.0 [False]); 268.6 (target 30.0 [False])
       3  8.38e+03  2.93e+02  1.40e-01  1.47e+03    1.05e+02      0   Skip BFGS  
    geophys. misfits: 42.5 (target 30.0 [False]); 39.8 (target 30.0 [False])
       4  1.68e+03  4.00e+01  1.51e-01  2.93e+02    7.51e+01      0   Skip BFGS  
    geophys. misfits: 21.0 (target 30.0 [True]); 20.7 (target 30.0 [True])
    All targets have been reached
    ------------------------- STOP! -------------------------
    1 : |fc-fOld| = 0.0000e+00 <= tolF*(1+|f0|) = 3.0000e+04
    0 : |xc-x_last| = 5.4380e-01 <= tolX*(1+|x0|) = 1.0000e-06
    0 : |proj(x-g)-x|    = 7.5030e+01 <= tolG          = 1.0000e-01
    0 : |proj(x-g)-x|    = 7.5030e+01 <= 1e3*eps       = 1.0000e-02
    0 : maxIter   =      50    <= iter          =      5
    ------------------------- DONE! -------------------------
    /home/ssoler/git/simpeg/examples/10-pgi/plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py:301: UserWarning:

    marker is redundantly defined by the 'marker' keyword argument and the fmt string "b.-" (-> marker='.'). The keyword argument will take precedence.

    /home/ssoler/git/simpeg/examples/10-pgi/plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py:308: UserWarning:

    marker is redundantly defined by the 'marker' keyword argument and the fmt string "r.-" (-> marker='.'). The keyword argument will take precedence.

    /home/ssoler/git/simpeg/examples/10-pgi/plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py:346: UserWarning:

    marker is redundantly defined by the 'marker' keyword argument and the fmt string "b.-" (-> marker='.'). The keyword argument will take precedence.

    /home/ssoler/git/simpeg/examples/10-pgi/plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py:353: UserWarning:

    marker is redundantly defined by the 'marker' keyword argument and the fmt string "r.-" (-> marker='.'). The keyword argument will take precedence.

    /home/ssoler/git/simpeg/examples/10-pgi/plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py:360: UserWarning:

    The following kwargs were not used by contour: 'label'

    /home/ssoler/git/simpeg/examples/10-pgi/plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py:368: UserWarning:

    The following kwargs were not used by contour: 'label'

    /home/ssoler/git/simpeg/examples/10-pgi/plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py:402: UserWarning:

    marker is redundantly defined by the 'marker' keyword argument and the fmt string "b.-" (-> marker='.'). The keyword argument will take precedence.

    /home/ssoler/git/simpeg/examples/10-pgi/plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py:409: UserWarning:

    marker is redundantly defined by the 'marker' keyword argument and the fmt string "r.-" (-> marker='.'). The keyword argument will take precedence.







|

.. code-block:: Python


    import discretize as Mesh
    import matplotlib.pyplot as plt
    import numpy as np
    from SimPEG import (
        data_misfit,
        directives,
        inverse_problem,
        inversion,
        maps,
        optimization,
        regularization,
        simulation,
        utils,
    )

    # Random seed for reproductibility
    np.random.seed(1)
    # Mesh
    N = 100
    mesh = Mesh.TensorMesh([N])

    # Survey design parameters
    nk = 30
    jk = np.linspace(1.0, 59.0, nk)
    p = -0.25
    q = 0.25


    # Physics
    def g(k):
        return np.exp(p * jk[k] * mesh.cell_centers_x) * np.cos(
            np.pi * q * jk[k] * mesh.cell_centers_x
        )


    G = np.empty((nk, mesh.nC))

    for i in range(nk):
        G[i, :] = g(i)

    m0 = np.zeros(mesh.nC)
    m0[20:41] = np.linspace(0.0, 1.0, 21)
    m0[41:57] = np.linspace(-1, 0.0, 16)

    poly0 = maps.PolynomialPetroClusterMap(coeffyx=np.r_[0.0, -4.0, 4.0])
    poly1 = maps.PolynomialPetroClusterMap(coeffyx=np.r_[-0.0, 3.0, 6.0, 6.0])
    poly0_inverse = maps.PolynomialPetroClusterMap(coeffyx=-np.r_[0.0, -4.0, 4.0])
    poly1_inverse = maps.PolynomialPetroClusterMap(coeffyx=-np.r_[0.0, 3.0, 6.0, 6.0])
    cluster_mapping = [maps.IdentityMap(), poly0_inverse, poly1_inverse]

    m1 = np.zeros(100)
    m1[20:41] = 1.0 + (poly0 * np.vstack([m0[20:41], m1[20:41]]).T)[:, 1]
    m1[41:57] = -1.0 + (poly1 * np.vstack([m0[41:57], m1[41:57]]).T)[:, 1]

    model2d = np.vstack([m0, m1]).T
    m = utils.mkvc(model2d)

    clfmapping = utils.GaussianMixtureWithNonlinearRelationships(
        mesh=mesh,
        n_components=3,
        covariance_type="full",
        tol=1e-8,
        reg_covar=1e-3,
        max_iter=1000,
        n_init=100,
        init_params="kmeans",
        random_state=None,
        warm_start=False,
        means_init=np.array(
            [
                [0, 0],
                [m0[20:41].mean(), m1[20:41].mean()],
                [m0[41:57].mean(), m1[41:57].mean()],
            ]
        ),
        verbose=0,
        verbose_interval=10,
        cluster_mapping=cluster_mapping,
    )
    clfmapping = clfmapping.fit(model2d)

    clfnomapping = utils.WeightedGaussianMixture(
        mesh=mesh,
        n_components=3,
        covariance_type="full",
        tol=1e-8,
        reg_covar=1e-3,
        max_iter=1000,
        n_init=100,
        init_params="kmeans",
        random_state=None,
        warm_start=False,
        verbose=0,
        verbose_interval=10,
    )
    clfnomapping = clfnomapping.fit(model2d)

    wires = maps.Wires(("m1", mesh.nC), ("m2", mesh.nC))

    relatrive_error = 0.01
    noise_floor = 0.0

    prob1 = simulation.LinearSimulation(mesh, G=G, model_map=wires.m1)
    survey1 = prob1.make_synthetic_data(
        m, relative_error=relatrive_error, noise_floor=noise_floor, add_noise=True
    )

    prob2 = simulation.LinearSimulation(mesh, G=G, model_map=wires.m2)
    survey2 = prob2.make_synthetic_data(
        m, relative_error=relatrive_error, noise_floor=noise_floor, add_noise=True
    )


    dmis1 = data_misfit.L2DataMisfit(simulation=prob1, data=survey1)
    dmis2 = data_misfit.L2DataMisfit(simulation=prob2, data=survey2)
    dmis = dmis1 + dmis2
    minit = np.zeros_like(m)

    # Distance weighting
    wr1 = np.sum(prob1.G**2.0, axis=0) ** 0.5 / mesh.cell_volumes
    wr1 = wr1 / np.max(wr1)
    wr2 = np.sum(prob2.G**2.0, axis=0) ** 0.5 / mesh.cell_volumes
    wr2 = wr2 / np.max(wr2)

    reg_simple = regularization.PGI(
        mesh=mesh,
        gmmref=clfmapping,
        gmm=clfmapping,
        approx_gradient=True,
        wiresmap=wires,
        non_linear_relationships=True,
        weights_list=[wr1, wr2],
    )

    opt = optimization.ProjectedGNCG(
        maxIter=50,
        tolX=1e-6,
        maxIterCG=100,
        tolCG=1e-3,
        lower=-10,
        upper=10,
    )

    invProb = inverse_problem.BaseInvProblem(dmis, reg_simple, opt)

    # directives
    scales = directives.ScalingMultipleDataMisfits_ByEig(
        chi0_ratio=np.r_[1.0, 1.0], verbose=True, n_pw_iter=10
    )
    scaling_schedule = directives.JointScalingSchedule(verbose=True)
    alpha0_ratio = np.r_[1e6, 1e4, 1, 1]
    alphas = directives.AlphasSmoothEstimate_ByEig(
        alpha0_ratio=alpha0_ratio, n_pw_iter=10, verbose=True
    )
    beta = directives.BetaEstimate_ByEig(beta0_ratio=1e-5, n_pw_iter=10)
    betaIt = directives.PGI_BetaAlphaSchedule(
        verbose=True,
        coolingFactor=2.0,
        progress=0.2,
    )
    targets = directives.MultiTargetMisfits(verbose=True)
    petrodir = directives.PGI_UpdateParameters(update_gmm=False)

    # Setup Inversion
    inv = inversion.BaseInversion(
        invProb,
        directiveList=[alphas, scales, beta, petrodir, targets, betaIt, scaling_schedule],
    )

    mcluster_map = inv.run(minit)

    # Inversion with no nonlinear mapping
    reg_simple_no_map = regularization.PGI(
        mesh=mesh,
        gmmref=clfnomapping,
        gmm=clfnomapping,
        approx_gradient=True,
        wiresmap=wires,
        non_linear_relationships=False,
        weights_list=[wr1, wr2],
    )

    opt = optimization.ProjectedGNCG(
        maxIter=50,
        tolX=1e-6,
        maxIterCG=100,
        tolCG=1e-3,
        lower=-10,
        upper=10,
    )

    invProb = inverse_problem.BaseInvProblem(dmis, reg_simple_no_map, opt)

    # directives
    scales = directives.ScalingMultipleDataMisfits_ByEig(
        chi0_ratio=np.r_[1.0, 1.0], verbose=True, n_pw_iter=10
    )
    scaling_schedule = directives.JointScalingSchedule(verbose=True)
    alpha0_ratio = np.r_[100.0 * np.ones(2), 1, 1]
    alphas = directives.AlphasSmoothEstimate_ByEig(
        alpha0_ratio=alpha0_ratio, n_pw_iter=10, verbose=True
    )
    beta = directives.BetaEstimate_ByEig(beta0_ratio=1e-5, n_pw_iter=10)
    betaIt = directives.PGI_BetaAlphaSchedule(
        verbose=True,
        coolingFactor=2.0,
        progress=0.2,
    )
    targets = directives.MultiTargetMisfits(
        chiSmall=1.0, TriggerSmall=True, TriggerTheta=False, verbose=True
    )
    petrodir = directives.PGI_UpdateParameters(update_gmm=False)

    # Setup Inversion
    inv = inversion.BaseInversion(
        invProb,
        directiveList=[alphas, scales, beta, petrodir, targets, betaIt, scaling_schedule],
    )

    mcluster_no_map = inv.run(minit)

    # WeightedLeastSquares Inversion

    reg1 = regularization.WeightedLeastSquares(
        mesh, alpha_s=1.0, alpha_x=1.0, mapping=wires.m1, weights={"cell_weights": wr1}
    )

    reg2 = regularization.WeightedLeastSquares(
        mesh, alpha_s=1.0, alpha_x=1.0, mapping=wires.m2, weights={"cell_weights": wr2}
    )

    reg = reg1 + reg2

    opt = optimization.ProjectedGNCG(
        maxIter=50,
        tolX=1e-6,
        maxIterCG=100,
        tolCG=1e-3,
        lower=-10,
        upper=10,
    )

    invProb = inverse_problem.BaseInvProblem(dmis, reg, opt)

    # directives
    alpha0_ratio = np.r_[1, 1, 1, 1]
    alphas = directives.AlphasSmoothEstimate_ByEig(
        alpha0_ratio=alpha0_ratio, n_pw_iter=10, verbose=True
    )
    scales = directives.ScalingMultipleDataMisfits_ByEig(
        chi0_ratio=np.r_[1.0, 1.0], verbose=True, n_pw_iter=10
    )
    scaling_schedule = directives.JointScalingSchedule(verbose=True)
    beta = directives.BetaEstimate_ByEig(beta0_ratio=1e-5, n_pw_iter=10)
    beta_schedule = directives.BetaSchedule(coolingFactor=5.0, coolingRate=1)
    targets = directives.MultiTargetMisfits(
        TriggerSmall=False,
        verbose=True,
    )

    # Setup Inversion
    inv = inversion.BaseInversion(
        invProb,
        directiveList=[alphas, scales, beta, targets, beta_schedule, scaling_schedule],
    )

    mtik = inv.run(minit)


    # Final Plot
    fig, axes = plt.subplots(3, 4, figsize=(25, 15))
    axes = axes.reshape(12)
    left, width = 0.25, 0.5
    bottom, height = 0.25, 0.5
    right = left + width
    top = bottom + height

    axes[0].set_axis_off()
    axes[0].text(
        0.5 * (left + right),
        0.5 * (bottom + top),
        ("Using true nonlinear\npetrophysical relationships"),
        horizontalalignment="center",
        verticalalignment="center",
        fontsize=20,
        color="black",
        transform=axes[0].transAxes,
    )

    axes[1].plot(mesh.cell_centers_x, wires.m1 * mcluster_map, "b.-", ms=5, marker="v")
    axes[1].plot(mesh.cell_centers_x, wires.m1 * m, "k--")
    axes[1].set_title("Problem 1")
    axes[1].legend(["Recovered Model", "True Model"], loc=1)
    axes[1].set_xlabel("X")
    axes[1].set_ylabel("Property 1")

    axes[2].plot(mesh.cell_centers_x, wires.m2 * mcluster_map, "r.-", ms=5, marker="v")
    axes[2].plot(mesh.cell_centers_x, wires.m2 * m, "k--")
    axes[2].set_title("Problem 2")
    axes[2].legend(["Recovered Model", "True Model"], loc=1)
    axes[2].set_xlabel("X")
    axes[2].set_ylabel("Property 2")

    x, y = np.mgrid[-1:1:0.01, -4:2:0.01]
    pos = np.empty(x.shape + (2,))
    pos[:, :, 0] = x
    pos[:, :, 1] = y
    CS = axes[3].contour(
        x,
        y,
        np.exp(clfmapping.score_samples(pos.reshape(-1, 2)).reshape(x.shape)),
        100,
        alpha=0.25,
        cmap="viridis",
    )
    axes[3].scatter(wires.m1 * mcluster_map, wires.m2 * mcluster_map, marker="v")
    axes[3].set_title("Petrophysical Distribution")
    CS.collections[0].set_label("")
    axes[3].legend(["True Petrophysical Distribution", "Recovered model crossplot"])
    axes[3].set_xlabel("Property 1")
    axes[3].set_ylabel("Property 2")

    axes[4].set_axis_off()
    axes[4].text(
        0.5 * (left + right),
        0.5 * (bottom + top),
        ("Using a pure\nGaussian distribution"),
        horizontalalignment="center",
        verticalalignment="center",
        fontsize=20,
        color="black",
        transform=axes[4].transAxes,
    )

    axes[5].plot(mesh.cell_centers_x, wires.m1 * mcluster_no_map, "b.-", ms=5, marker="v")
    axes[5].plot(mesh.cell_centers_x, wires.m1 * m, "k--")
    axes[5].set_title("Problem 1")
    axes[5].legend(["Recovered Model", "True Model"], loc=1)
    axes[5].set_xlabel("X")
    axes[5].set_ylabel("Property 1")

    axes[6].plot(mesh.cell_centers_x, wires.m2 * mcluster_no_map, "r.-", ms=5, marker="v")
    axes[6].plot(mesh.cell_centers_x, wires.m2 * m, "k--")
    axes[6].set_title("Problem 2")
    axes[6].legend(["Recovered Model", "True Model"], loc=1)
    axes[6].set_xlabel("X")
    axes[6].set_ylabel("Property 2")

    CSF = axes[7].contour(
        x,
        y,
        np.exp(clfmapping.score_samples(pos.reshape(-1, 2)).reshape(x.shape)),
        100,
        alpha=0.5,
        label="True Petro. Distribution",
    )
    CS = axes[7].contour(
        x,
        y,
        np.exp(clfnomapping.score_samples(pos.reshape(-1, 2)).reshape(x.shape)),
        500,
        cmap="viridis",
        linestyles="--",
        label="Modeled Petro. Distribution",
    )
    axes[7].scatter(
        wires.m1 * mcluster_no_map,
        wires.m2 * mcluster_no_map,
        marker="v",
        label="Recovered model crossplot",
    )
    axes[7].set_title("Petrophysical Distribution")
    axes[7].legend()
    axes[7].set_xlabel("Property 1")
    axes[7].set_ylabel("Property 2")

    # Tikonov

    axes[8].set_axis_off()
    axes[8].text(
        0.5 * (left + right),
        0.5 * (bottom + top),
        ("Least-Squares\n~Using a single cluster"),
        horizontalalignment="center",
        verticalalignment="center",
        fontsize=20,
        color="black",
        transform=axes[8].transAxes,
    )

    axes[9].plot(mesh.cell_centers_x, wires.m1 * mtik, "b.-", ms=5, marker="v")
    axes[9].plot(mesh.cell_centers_x, wires.m1 * m, "k--")
    axes[9].set_title("Problem 1")
    axes[9].legend(["Recovered Model", "True Model"], loc=1)
    axes[9].set_xlabel("X")
    axes[9].set_ylabel("Property 1")

    axes[10].plot(mesh.cell_centers_x, wires.m2 * mtik, "r.-", ms=5, marker="v")
    axes[10].plot(mesh.cell_centers_x, wires.m2 * m, "k--")
    axes[10].set_title("Problem 2")
    axes[10].legend(["Recovered Model", "True Model"], loc=1)
    axes[10].set_xlabel("X")
    axes[10].set_ylabel("Property 2")

    CS = axes[11].contour(
        x,
        y,
        np.exp(clfmapping.score_samples(pos.reshape(-1, 2)).reshape(x.shape)),
        100,
        alpha=0.25,
        cmap="viridis",
    )
    axes[11].scatter(wires.m1 * mtik, wires.m2 * mtik, marker="v")
    axes[11].set_title("Petro Distribution")
    CS.collections[0].set_label("")
    axes[11].legend(["True Petro Distribution", "Recovered model crossplot"])
    axes[11].set_xlabel("Property 1")
    axes[11].set_ylabel("Property 2")
    plt.subplots_adjust(wspace=0.3, hspace=0.3, top=0.85)
    plt.show()


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 53.765 seconds)

**Estimated memory usage:**  10 MB


.. _sphx_glr_download_content_examples_10-pgi_plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_inv_1_PGI_Linear_1D_joint_WithRelationships.ipynb <plot_inv_1_PGI_Linear_1D_joint_WithRelationships.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py <plot_inv_1_PGI_Linear_1D_joint_WithRelationships.py>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
